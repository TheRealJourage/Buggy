; PlatformIO Project Configuration File
;
; LIN Bus Steering Control System
; - RP2040 Slave (Waveshare RP2040-Tiny)
; - Arduino Uno R3 Master
;
; Hardware Setup: 5V Laboratory Power Supply
;
; Build configuration for PlatformIO IDE
; https://docs.platformio.org/page/projectconf.html

[platformio]
default_envs = rp2040_slave, uno_master
src_dir = .
include_dir = .

; ============================================================================
; COMMON SETTINGS
; ============================================================================
[common]
build_flags =
    -Wall
    -Wextra
    -D LIN_BAUD_RATE=19200
monitor_speed = 115200
monitor_filters =
    default
    time

; ============================================================================
; RP2040 SLAVE (Waveshare RP2040-Tiny)
; ============================================================================
[env:rp2040_slave]
platform = https://github.com/maxgerhardt/platform-raspberrypi.git
board = waveshare_rp2040_tiny
framework = arduino
board_build.core = earlephilhower
board_build.filesystem_size = 0.5m

; Build settings
build_flags =
    ${common.build_flags}
    -D ARDUINO_ARCH_RP2040
    -D PICO_BOARD="waveshare_rp2040_tiny"
    -O2

; Upload settings
upload_protocol = picotool
upload_speed = 921600

; Monitor settings
monitor_speed = ${common.monitor_speed}
monitor_port = auto
monitor_filters = ${common.monitor_filters}

; Source files
src_filter =
    +<steering_wheel_controller.ino>
    -<lin_bus_master.ino>

; Library dependencies
lib_deps =

; Extra scripts (optional)
extra_scripts =

; ============================================================================
; ARDUINO UNO R3 MASTER
; ============================================================================
[env:uno_master]
platform = atmelavr
board = uno
framework = arduino

; Build settings
build_flags =
    ${common.build_flags}
    -D ARDUINO_ARCH_AVR
    -Os

; Upload settings
upload_protocol = arduino
upload_speed = 115200
upload_port = auto

; Monitor settings (NOTE: Serial conflicts with LIN on pins 0/1!)
; For debugging, disconnect LIN transceiver from pins 0/1
monitor_speed = ${common.monitor_speed}
monitor_port = auto
monitor_filters = ${common.monitor_filters}

; Source files
src_filter =
    +<lin_bus_master.ino>
    -<steering_wheel_controller.ino>

; Library dependencies
lib_deps =

; Extra scripts (optional)
extra_scripts =

; ============================================================================
; DEBUG CONFIGURATION (for testing with Serial output)
; ============================================================================
[env:uno_master_debug]
extends = env:uno_master
build_flags =
    ${env:uno_master.build_flags}
    -D ENABLE_SERIAL_DEBUG

; Note: For Serial debugging on Arduino Uno:
; 1. Uncomment Serial.println() lines in lin_bus_master.ino
; 2. Build with this environment
; 3. Disconnect MCP2003 from pins 0/1
; 4. Upload and open Serial Monitor
; 5. Reconnect MCP2003 for LIN operation

; ============================================================================
; UPLOAD INSTRUCTIONS
; ============================================================================
;
; Upload to RP2040 Slave:
;   pio run -e rp2040_slave -t upload
;
; Upload to Arduino Uno Master:
;   pio run -e uno_master -t upload
;
; Upload both (sequential):
;   pio run -t upload
;
; Build without upload:
;   pio run -e rp2040_slave
;   pio run -e uno_master
;
; Clean build files:
;   pio run -t clean
;
; Open Serial Monitor:
;   pio device monitor -e rp2040_slave
;   pio device monitor -e uno_master
;
; ============================================================================
; TROUBLESHOOTING
; ============================================================================
;
; RP2040 Upload Issues:
; - Hold BOOTSEL button while plugging in USB
; - Board should appear as USB Mass Storage device
; - If picotool fails, try: upload_protocol = mbed
;
; Arduino Uno Upload Issues:
; - Disconnect MCP2003 from pins 0/1 during upload
; - Check correct COM port selected
; - Try slower upload speed: upload_speed = 57600
;
; Serial Monitor Shows Garbage:
; - Check monitor_speed matches Serial.begin() in code
; - For RP2040: Usually 115200 baud
; - For Arduino Uno LIN: 19200 baud (but conflicts with LIN!)
;
; ============================================================================
